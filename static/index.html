<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>CompHDL demo</title>
        <style>
            body {
                background-color: #eee;
            }
            input {
                font-family: monospace;
            }
            textarea {
                font-family: monospace;
            }
            .code {
                width: 95%;
            }
            #container {
              display: flex;
              flex-direction: row;
              flex-wrap: wrap;
            }
            .div-1, .div-3 {
              flex: 1 1 0;
            }
            .div-2 {
               flex: 100%;
               order: 3;
            }
            #draggableControls {
                /* position: absolute; */
                border: 1px solid #d3d3d3;
                padding: 8px;
                background-color: #bbbbbb;
            }
            #draggableControlsheader {
                cursor: move;
                padding: 10px;
            }
        </style>
        <style id="wire_style"></style>
    </head>
    <body>
        <div id="loading_wasm" style="display: block; color: #F00;">
            WARNING: LOADING WASM... (if this message persists for a long time,
            check if your browser supports WASM and disable any adblockers)
        </div>
        <div id="loaded_wasm" style="display: none; color: #0F0;">
            WASM MODULE SUCCESSFULLY LOADED
        </div>
        <div id="container">
        <div class="div-1">
            <div>
              <label for=exampleName>Load example:</label>
              <select id=exampleName></select>
              <button id=loadExampleButton onClick="loadExampleSelect()">LOAD EXAMPLE</button>
            </div>
            <div>
              <input type="text" id="top_name" placeholder="Top component name"></input>
              <button id="comphdl_start" onClick="runGui()">RUN!</button>
            </div>
                <div id="simulation_controls" style="display: none;">
            <div id="draggableControls">
                <small id="draggableControlsheader">Make this floating and move it:</small>
                <button onClick="document.getElementById('draggableControls').style.position='absolute';">FLOATING</button>
                <button onClick="document.getElementById('draggableControls').style.position='static';">FIXED</button>
                  <div>
                    <input type="text" id="tick_display">
                    <input type="text" id="target_ticks_per_second">
                    <input type="checkbox" id="check_run_step"> running step
                    <input type="checkbox" id="check_run_forever"> running forever
                    <input type="checkbox" id="check_alive"> rust alive
                    <input type="checkbox" id="check_show_debug" checked> show debug
                  </div>
                  <div>
                    <button id="pause_simulation" onClick="pauseSimulation()">PAUSE</button>
                    <button id="run_step" onClick="runStep()">ONE STEP</button>
                    <button id="run_forever" onClick="resumeSimulation()">RESUME</button>
                    <button id="stop_simulation" onClick="stopSimulation()">STOP</button>
                  </div>
                <div id="top_input"></div>
                <div id="top_output"></div>
                </div>
            </div>
            <div>
              <textarea id="comphdl_definition" class="code" style="height:500px;">
              </textarea>
            </div>
        </div>
        <div class="div-3">
            DEBUG OUTPUT:
            <textarea id="top_output_debug" style="height:400px; width:95%" placeholder="Simulation output" readonly></textarea>
            NETLIST JSON:
            <textarea id="comphdl_json" style="height:100px; width:95%" placeholder="Netlist json"></textarea>
            <div>
                <div style=display:flex;justify-content:space-between>
                    <button id=formatButton>Format JSON</button>
                    <div>
                        <label for=skinSelect>Select skin:</label>
                        <select id=skinSelect></select>
                        <button id=renderButton>Render</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="viewerContainer" class="div-2">
            <svg id="svgArea">
            </svg>
        </div>
        </div>
        <script src="comphdl.js"></script>
        <script src="elk.bundled.js"></script>
        <script src="netlistsvg.js"></script>
        <script>
            Rust.comphdl.then( function( comphdl ) {
                document.getElementById("loading_wasm").style.display = "none";
                document.getElementById("loaded_wasm").style.display = "block";
                
                loadExample(false, "example1.txt");
                var examples = ["example1.txt", "bufbufbuf.txt", "rslatch.txt"];
                var examplesSelect = document.getElementById("exampleName");
                examples.forEach(function(e, i) {
                    var option = document.createElement('option');
                    option.selected = i === 0;
                    option.value = e;
                    option.text = e;
                    examplesSelect.append(option);
                });
                dragElement(document.getElementById("draggableControls"));
            });
            function loadExampleSelect() {
                var name = document.getElementById("exampleName").value;
                stopSimulation();
                loadExample(true, name);
            }
            function loadExample(force, name) {
                var a = document.getElementById("comphdl_definition");
                // Do not overwrite existing code
                if(force == false && a.value != "") {
                    return;
                }
                fetch("./comphdl_examples/" + name).then(function(response) {
                    if (!response.ok) {
                        throw Error(response.statusText);
                    }
                    return response;
                }).then(function(response) {
                    response.text().then(function(text) {
                        a.value = text;
                    });
                });
            }
            function runGui() {
                Rust.comphdl.then( function( comphdl ) {
                    var alive = document.getElementById("check_alive");
                    // TODO: check if a thread is already running and kill it
                    if(alive.checked) {
                        // TODO: kill it
                    }
                    alive.checked = true;
                    comphdl.run_js_gui();
                    showSimulationControls();
                    document.getElementById("renderButton").click();
                    resumeSimulation();
                });
            }
            function resumeSimulation() {
                var a = document.getElementById("check_run_forever");
                a.checked = true;
            }
            function pauseSimulation() {
                var a = document.getElementById("check_run_forever");
                a.checked = false;
            }
            function stopSimulation() {
                var a = document.getElementById("check_alive");
                a.checked = false;
            }
            function runStep() {
                pauseSimulation();
                var a = document.getElementById("check_run_step");
                a.checked = true;
            }
            function hideSimulationControls() {
                document.getElementById("simulation_controls").style.display = "none";
            }
            function showSimulationControls() {
                document.getElementById("simulation_controls").style.display = "block";
            }
            function dragElement(elmnt) {
              var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
              if (document.getElementById(elmnt.id + "header")) {
                /* if present, the header is where you move the DIV from:*/
                document.getElementById(elmnt.id + "header").onmousedown = dragMouseDown;
              } else {
                /* otherwise, move the DIV from anywhere inside the DIV:*/
                elmnt.onmousedown = dragMouseDown;
              }

              function dragMouseDown(e) {
                e = e || window.event;
                // get the mouse cursor position at startup:
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                // call a function whenever the cursor moves:
                document.onmousemove = elementDrag;
              }

              function elementDrag(e) {
                e = e || window.event;
                // calculate the new cursor position:
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                // set the element's new position:
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
              }

              function closeDragElement() {
                /* stop moving when mouse button is released:*/
                document.onmouseup = null;
                document.onmousemove = null;
              }
            }
        </script>
    </body>
</html>
